source("project/plots/plotMDICSchar.R")

# Создаем сводную таблицу с частотами стратегий
strategy_data <- bind_rows(
  # Создаем данные для поведенческой сферы
  data.frame(
    Сфера = rep("Поведенческая сфера", nrow(data_MDICS)),  # Повторяем название сферы
    Стратегия = data_MDICS_coping_strategies_rus$Behavioral_sphere,  # Стратегии из поведенческой сферы
    Адаптивность = data_MDICS$Поведенческая.сфера  # Адаптивность для поведенческой сферы
  ),
  # Создаем данные для когнитивной сферы
  data.frame(
    Сфера = rep("Когнитивная сфера", nrow(data_MDICS)),  # Повторяем название сферы
    Стратегия = data_MDICS_coping_strategies_rus$Cognitive_sphere,  # Стратегии из когнитивной сферы
    Адаптивность = data_MDICS$Когнитивная.сфера  # Адаптивность для когнитивной сферы
  ),
  # Создаем данные для эмоциональной сферы
  data.frame(
    Сфера = rep("Эмоциональная сфера", nrow(data_MDICS)),  # Повторяем название сферы
    Стратегия = data_MDICS_coping_strategies_rus$Emotional_sphere,  # Стратегии из эмоциональной сферы
    Адаптивность = data_MDICS$Эмоциональная.сфера  # Адаптивность для эмоциональной сферы
  )
) %>%
  # Группируем данные по сфере, стратегии и адаптивности
  group_by(Сфера, Стратегия, Адаптивность) %>%
  # Считаем количество вхождений каждой комбинации
  summarise(Количество = n(), .groups = "drop") %>%
  # Группируем данные по сфере для расчета процентов
  group_by(Сфера) %>%
  # Рассчитываем процент использования каждой стратегии
  mutate(Процент = round(Количество / sum(Количество) * 100, 1))
  

# Определим цвета для уровней адаптивности
color_palette <- c(
  "Конструктивный" = "#1b9e77",  # зеленый
  "Относительно конструктивный" = "#FFD700",  # золотой/желтый
  "Неконструктивный" = "#d95f02"  # красный
)


# Создаем график
ggplot(strategy_data, 
       aes(x = Сфера, y = Процент, fill = Адаптивность)
       ) +
  # Столбчатая диаграмма с накоплением
  geom_col(
    position = position_stack(), width = 0.7
    ) +
  # Добавляем текст на график
  geom_text(
    aes(
      label = ifelse(
        Процент > 5, paste0(Процент, "%"), "")),  # Показываем процент, если он больше 5
    
    position = position_stack(vjust = 0.5),  # Позиционируем текст по центру столбца
    size = 3,  # Размер текста
    color = "black"  # Цвет текста
  ) +
  # Разбиваем график на несколько панелей по стратегиям
  facet_wrap(~ Стратегия, ncol = 3) +
  # Устанавливаем цвета для уровней адаптивности
  scale_fill_manual(
    values = color_palette,  # Используем заранее определенную палитру цветов
    name = "Уровень адаптивности",  # Заголовок легенды
    labels = c("Адаптивный", "Относительно адаптивный", "Неадаптивный")  # Метки для легенды
  ) +
  # Настраиваем ось Y
  scale_y_continuous(
    limits = c(0, 100),  # Устанавливаем пределы оси Y от 0 до 100
    breaks = seq(0, 100, by = 20),  # Устанавливаем деления на оси Y
    expand = expansion(mult = c(0, 0.1))  # Расширяем ось Y для лучшего отображения
  ) +
  # Добавляем заголовки и подписи
  labs(
    title = "Распределение конкретных копинг-стратегий по сферам",  # Заголовок графика
    subtitle = "С цветовой индикацией уровня адаптивности стратегий",  # Подзаголовок
    x = "Сферы копинг-поведения",  # Подпись оси X
    y = "Процент использования стратегии",  # Подпись оси Y
    fill = "Уровень адаптивности"  # Подпись для легенды
  ) +
  # Используем минималистичный стиль
  theme_minimal() +
  # Настраиваем внешний вид графика
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),  # Поворачиваем текст на оси X
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),  # Настраиваем заголовок
    plot.subtitle = element_text(hjust = 0.5, size = 12),  # Настраиваем подзаголовок
    legend.position = "top",  # Позиция легенды
    panel.spacing = unit(1, "lines"),  # Расстояние между панелями
    strip.text = element_text(size = 9, face = "bold")  # Настройка текста на панелях
  )


  
  
