source("project/plots/libs_and_data.R")
# Данные (уже загружены, но переименуем сферы на русский)
data_MDICS <- data.frame(
  "Поведенческая сфера" = c(
    "Относительно конструктивный", "Конструктивный", "Неконструктивный", 
    "Неконструктивный", "Конструктивный", "Относительно конструктивный", 
    "Неконструктивный", "Конструктивный", "Неконструктивный", 
    "Относительно конструктивный", "Относительно конструктивный", 
    "Конструктивный", "Конструктивный", "Относительно конструктивный", 
    "Неконструктивный", "Неконструктивный", "Относительно конструктивный", 
    "Конструктивный", "Относительно конструктивный", "Конструктивный", 
    "Неконструктивный", "Конструктивный", "Относительно конструктивный", 
    "Конструктивный", "Неконструктивный", "Относительно конструктивный", 
    "Неконструктивный", "Конструктивный", "Относительно конструктивный", 
    "Неконструктивный", "Конструктивный", "Относительно конструктивный"
  ),
  "Когнитивная сфера" = c(
    "Конструктивный", "Конструктивный", "Относительно конструктивный", 
    "Неконструктивный", "Неконструктивный", "Относительно конструктивный", 
    "Относительно конструктивный", "Конструктивный", "Относительно конструктивный", 
    "Конструктивный", "Конструктивный", "Неконструктивный", 
    "Неконструктивный", "Неконструктивный", "Относительно конструктивный", 
    "Конструктивный", "Конструктивный", "Конструктивный", 
    "Конструктивный", "Относительно конструктивный", "Неконструктивный", 
    "Конструктивный", "Конструктивный", "Конструктивный", 
    "Конструктивный", "Конструктивный", "Конструктивный", 
    "Неконструктивный", "Конструктивный", "Относительно конструктивный",
    "Относительно конструктивный", "Неконструктивный"
  ),
  "Эмоциональная сфера" = c(
    "Неконструктивный", "Относительно конструктивный", "Неконструктивный", 
    "Неконструктивный", "Относительно конструктивный", "Относительно конструктивный", 
    "Конструктивный", "Конструктивный", "Неконструктивный", 
    "Относительно конструктивный", "Конструктивный", "Неконструктивный", 
    "Конструктивный", "Конструктивный", "Конструктивный", 
    "Неконструктивный", "Конструктивный", "Относительно конструктивный", 
    "Конструктивный", "Неконструктивный", "Неконструктивный", 
    "Неконструктивный", "Неконструктивный", "Конструктивный", 
    "Конструктивный", "Конструктивный", "Конструктивный", 
    "Неконструктивный", "Конструктивный", "Конструктивный",
    "Конструктивный", "Относительно конструктивный"
  )
)

# Преобразуем данные, оставляем только "Адаптивный" и "Неадаптивный"
plot_data <- data_MDICS %>%
  pivot_longer(
    cols = everything(),
    names_to = "Сфера",
    values_to = "Тип_копинга"
  ) %>%
  mutate(
    Тип_копинга = case_when(
      Тип_копинга == "Конструктивный" ~ "Адаптивный копинг",
      Тип_копинга == "Неконструктивный" ~ "Неадаптивный копинг",
      TRUE ~ NA_character_  # Убираем "Относительно конструктивный"
    )
  ) %>%
  filter(!is.na(Тип_копинга)) %>%  # Удаляем NA
  group_by(Сфера, Тип_копинга) %>%
  summarise(Количество = n(), .groups = "drop") %>%
  group_by(Сфера) %>%
  mutate(Процент = round(Количество / sum(Количество) * 100, 1))

# График
ggplot(plot_data, aes(x = Сфера, y = Процент, fill = Тип_копинга)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(
    aes(label = paste0(Процент, "%")),
    position = position_dodge(width = 0.8),
    vjust = -0.5,
    size = 4
  ) +
  scale_fill_manual(
    values = c(
      "Адаптивный копинг" = "#1b9e77",  # Зелёный
      "Неадаптивный копинг" = "#d95f02"  # Красный
    ),
    name = "Тип копинга"
  ) +
  scale_y_continuous(
    limits = c(0, 100),
    breaks = seq(0, 100, by = 10),
    expand = expansion(mult = c(0, 0.1))
  ) +
  labs(
    title = "Распределение копинг-стратегий по сферам (методика Хайма)",
    x = "Сферы копинг-поведения",
    y = "Процент респондентов",
    fill = "Тип копинга"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = "top",
    panel.grid.major.x = element_blank()
  )